<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is hiring? Hacker News jobs report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimal custom bits for sort indicators and remote badges */
        th.sortable::after { content: " ‚Üï"; opacity: 0.5; font-size: 0.8em; }
        th.sort-asc::after { content: " ‚Üë"; opacity: 1; }
        th.sort-desc::after { content: " ‚Üì"; opacity: 1; }
        .remote-yes { color: #16a34a; font-weight: 600; }
        .remote-no { color: #6b7280; }
        .btn-hn { background: #ff6600; }
        .btn-hn:hover { background: #e65a00; }
        .data-row { cursor: pointer; }
        .cell-text { cursor: text; }
        a.cell-text { cursor: pointer; }
        .detail-content { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease, opacity 0.25s ease; }
        .detail-accent::before { content: ""; position: absolute; inset: 0 auto 0 0; width: 4px; background: #4f46e5; }
        .detail-box { padding: 16px; }
        .full-content a { color: #2563eb; text-decoration: underline; word-break: break-word; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-5">
    <div class="w-full bg-white shadow-2xl rounded-xl overflow-hidden">
        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white px-8 py-6 text-center">
            <h1 class="text-3xl font-bold mb-2">üîç Who is hiring? Hacker News jobs report</h1>
            <p class="text-white/90">Found {{ total_matches }} matches from Hacker News "Who is hiring?" threads</p>
        </div>
        
        <div class="bg-slate-50 px-6 py-5 border-b border-slate-200">
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-7 items-end">
                <div class="flex flex-col">
                    <label for="search" class="text-sm font-semibold text-slate-700 mb-1">Search (Company, Role, Location...)</label>
                    <input type="text" id="search" placeholder="Type to search..." oninput="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-col">
                    <label for="remote-filter" class="text-sm font-semibold text-slate-700 mb-1">Remote</label>
                    <select id="remote-filter" onchange="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="location-filter" class="text-sm font-semibold text-slate-700 mb-1">Location</label>
                    <input type="text" id="location-filter" placeholder="e.g., San Francisco" oninput="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-col">
                    <label for="company-filter" class="text-sm font-semibold text-slate-700 mb-1">Company</label>
                    <input type="text" id="company-filter" placeholder="Company name..." oninput="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-col">
                    <label for="date-from" class="text-sm font-semibold text-slate-700 mb-1">Date from</label>
                    <input type="date" id="date-from" oninput="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-col">
                    <label for="date-to" class="text-sm font-semibold text-slate-700 mb-1">Date to</label>
                    <input type="date" id="date-to" oninput="filterTable()" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-center justify-end gap-3">
                    <button type="button" class="inline-flex items-center justify-center px-4 py-2 rounded-md border border-slate-300 bg-white text-slate-700 font-semibold shadow-sm hover:bg-slate-100" onclick="clearFilters()">Clear filters</button>
                    <span id="visible-summary" class="hidden sm:inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold text-slate-500 tracking-wide"></span>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto max-h-[70vh]">
            <table id="matches-table" class="w-full text-sm table-fixed min-w-[1100px] border-collapse">
                <thead class="bg-indigo-600 text-white sticky top-0 z-10">
                    <tr>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(0)">Company</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(1)">Stage</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(2)">Role</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(3)">Location</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(4)">Remote</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(5)">Type</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(6)">Compensation</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(7)">Equity</th>
                        <th class="sortable whitespace-nowrap px-4 py-3 text-left font-semibold cursor-pointer" onclick="sortTable(8)">Date</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-200">
                    {% for row in rows %}
                    <tr id="{{ row.row_id }}" class="data-row" data-expanded="false">
                        <td class="px-4 py-3 font-semibold text-slate-900">
                            {% if row.company_url %}
                            <a href="{{ row.company_url | e }}" target="_blank" class="cell-text text-indigo-600 hover:underline">{{ row.company | e }}</a>
                            {% else %}
                            <span class="cell-text">{{ row.company | e }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-slate-600"><span class="cell-text">{{ row.company_stage | e }}</span></td>
                        <td class="px-4 py-3 text-slate-800"><span class="cell-text">{{ row.role | e }}</span></td>
                        <td class="px-4 py-3 text-slate-600"><span class="cell-text">{{ row.location | e }}</span></td>
                        <td class="px-4 py-3 text-center"><span class="cell-text {{ row.remote_class | e }}">{{ row.remote | e }}</span></td>
                        <td class="px-4 py-3 text-slate-700"><span class="cell-text">{{ row.employment | e }}</span></td>
                        <td class="px-4 py-3 text-emerald-600 font-medium"><span class="cell-text">{{ row.cash_comp | e }}</span></td>
                        <td class="px-4 py-3 text-slate-700"><span class="cell-text">{{ row.equity | e }}</span></td>
                        <td class="px-4 py-3 text-slate-600 whitespace-nowrap"><span class="cell-text">{{ row.date | e }}</span></td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                {% if row.apply_url %}
                                <a href="{{ row.apply_url | e }}" target="_blank" class="link-btn inline-flex items-center px-3 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold">Apply</a>
                                {% endif %}
                                <a href="{{ row.post_url | e }}" target="_blank" class="link-btn inline-flex items-center px-3 py-2 rounded-md btn-hn text-white text-xs font-semibold">HN</a>
                            </div>
                        </td>
                    </tr>
                    <tr id="{{ row.row_id }}-detail" class="detail-row bg-slate-50" style="display: none;">
                        <td colspan="10" class="relative p-0 detail-accent">
                            <div class="detail-content">
                                <div class="detail-box">
                                    <h4 class="text-indigo-600 font-semibold mb-2">Full Content:</h4>
                                    <div class="full-content leading-6 text-slate-900 whitespace-pre-wrap break-words">{{ row.full_content_html | safe }}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="no-results" class="no-results text-center py-12 text-slate-500 text-lg" style="display: none;">
                No matches found. Try adjusting your filters.
            </div>
        </div>
    </div>
    
    <script>
        let allRows = [];
        let totalCount = 0;
        let currentSort = { column: -1, direction: 'asc' };
        const storageKey = 'hn-report-filters';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('.data-row');
            allRows = Array.from(rows);
            totalCount = allRows.length;
            updateVisibleSummary(totalCount);
            restoreFilters();

            const tbody = document.getElementById('table-body');
            if (tbody) {
                tbody.addEventListener('click', function(event) {
                    const row = event.target.closest('.data-row');
                    if (!row) return;

                    const target = event.target;
                    if (target.closest('button, a, input, textarea, select, label')) return;
                    if (target.closest('.cell-text')) return;

                    toggleRow(row.id);
                });
            }
        });

        function clearFilters() {
            document.getElementById('search').value = '';
            document.getElementById('remote-filter').value = '';
            document.getElementById('location-filter').value = '';
            document.getElementById('company-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            localStorage.removeItem(storageKey);
            filterTable();
        }
        
        function filterTable() {
            const search = document.getElementById('search').value.toLowerCase();
            const remoteFilter = document.getElementById('remote-filter').value;
            const locationFilter = document.getElementById('location-filter').value.toLowerCase();
            const locationTerms = locationFilter.split('||').map(t => t.trim()).filter(Boolean);
            const companyFilter = document.getElementById('company-filter').value.toLowerCase();
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            let visibleCount = 0;
            
            allRows.forEach((row) => {
                const cells = row.querySelectorAll('td');
                const company = cells[0].textContent.toLowerCase();
                const role = cells[2].textContent.toLowerCase();
                const location = cells[3].textContent.toLowerCase();
                const remote = cells[4].textContent.trim();
                const dateText = cells[8].textContent.trim();
                const detailRow = document.getElementById(row.id + '-detail');
                const isExpanded = row.dataset.expanded === 'true';

                const dateValue = Date.parse(dateText);
                const fromValue = dateFrom ? Date.parse(dateFrom) : null;
                const toValue = dateTo ? Date.parse(dateTo) : null;
                
                // Check filters
                const matchesSearch = !search || 
                    company.includes(search) || 
                    role.includes(search) || 
                    location.includes(search);
                const matchesRemote = !remoteFilter || remote === remoteFilter;
                const matchesLocation = !locationFilter || locationTerms.some(term => location.includes(term));
                const matchesCompany = !companyFilter || company.includes(companyFilter);
                const matchesFrom = !fromValue || (!isNaN(dateValue) && dateValue >= fromValue);
                // Add one day to toValue to make the filter inclusive for users in different TZs
                const adjustedTo = toValue !== null ? toValue + 24 * 60 * 60 * 1000 : null;
                const matchesTo = adjustedTo === null || (!isNaN(dateValue) && dateValue < adjustedTo);
                
                if (matchesSearch && matchesRemote && matchesLocation && matchesCompany && matchesFrom && matchesTo) {
                    row.style.display = '';
                    if (detailRow) detailRow.style.display = isExpanded ? '' : 'none';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                    if (detailRow) detailRow.style.display = 'none';
                }
            });
            
            updateVisibleSummary(visibleCount);
            document.getElementById('no-results').style.display = visibleCount === 0 ? 'block' : 'none';
            persistFilters();
        }
        
        function sortTable(column) {
            const tbody = document.getElementById('table-body');
            const rows = Array.from(tbody.querySelectorAll('.data-row'));
            const headers = document.querySelectorAll('th');
            
            // Reset header classes
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Determine sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update header
            headers[column].classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aVal = getSortValue(a, column);
                const bVal = getSortValue(b, column);

                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }

                const comparison = String(aVal).localeCompare(String(bVal), undefined, { numeric: true, sensitivity: 'base' });
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
            
            // Reorder rows in DOM (including detail rows)
            rows.forEach((row) => {
                const detailRow = document.getElementById(row.id + '-detail');
                tbody.appendChild(row);
                if (detailRow) tbody.appendChild(detailRow);
            });
            
            // Update allRows array
            allRows = rows;
        }
        
        function toggleRow(rowId) {
            const row = document.getElementById(rowId);
            const detailRow = document.getElementById(rowId + '-detail');
            if (!row || !detailRow) return;

            const content = detailRow.querySelector('.detail-content');
            const isExpanded = row.dataset.expanded === 'true';

            if (!content) {
                // Fallback without animation if content container is missing
                const nextExpanded = !isExpanded;
                row.dataset.expanded = nextExpanded ? 'true' : 'false';
                detailRow.style.display = nextExpanded ? '' : 'none';
                return;
            }

            if (!isExpanded) {
                // Expand
                detailRow.style.display = 'table-row';
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                requestAnimationFrame(() => {
                    const fullHeight = content.scrollHeight;
                    content.style.maxHeight = fullHeight + 'px';
                    content.style.opacity = '1';
                });

                const onExpandEnd = (event) => {
                    if (event.propertyName === 'max-height') {
                        content.style.maxHeight = 'none';
                        content.removeEventListener('transitionend', onExpandEnd);
                    }
                };
                content.addEventListener('transitionend', onExpandEnd);
                row.dataset.expanded = 'true';
            } else {
                // Collapse
                const currentHeight = content.scrollHeight;
                content.style.maxHeight = currentHeight + 'px';
                requestAnimationFrame(() => {
                    content.style.maxHeight = '0px';
                    content.style.opacity = '0';
                });

                const onCollapseEnd = (event) => {
                    if (event.propertyName === 'max-height') {
                        detailRow.style.display = 'none';
                        content.removeEventListener('transitionend', onCollapseEnd);
                    }
                };
                content.addEventListener('transitionend', onCollapseEnd);
                row.dataset.expanded = 'false';
            }
        }

        function getSortValue(row, column) {
            const cellText = row.querySelectorAll('td')[column].textContent.trim();

            // Date column (ISO-like): sort by timestamp
            if (column === 8) {
                const ts = Date.parse(cellText);
                if (!isNaN(ts)) return ts;
            }

            // Numeric fallback (e.g., compensation)
            const num = parseFloat(cellText.replace(/[^0-9.-]/g, ''));
            if (!isNaN(num)) return num;

            // Default to lowercase string for stable comparisons
            return cellText.toLowerCase();
        }
        
        function updateVisibleSummary(count) {
            const summary = document.getElementById('visible-summary');
            if (summary) {
                summary.textContent = `${count} / ${totalCount} visible`;
                summary.classList.remove('hidden');
            }
        }

        function persistFilters() {
            const data = {
                search: document.getElementById('search').value,
                remote: document.getElementById('remote-filter').value,
                location: document.getElementById('location-filter').value,
                company: document.getElementById('company-filter').value,
                dateFrom: document.getElementById('date-from').value,
                dateTo: document.getElementById('date-to').value,
            };
            try {
                localStorage.setItem(storageKey, JSON.stringify(data));
            } catch (e) {
                console.warn('Could not persist filters', e);
            }
        }

        function restoreFilters() {
            let data = null;
            try {
                data = JSON.parse(localStorage.getItem(storageKey));
            } catch (e) {
                console.warn('Could not restore filters', e);
            }
            if (!data) {
                filterTable();
                return;
            }

            document.getElementById('search').value = data.search || '';
            document.getElementById('remote-filter').value = data.remote || '';
            document.getElementById('location-filter').value = data.location || '';
            document.getElementById('company-filter').value = data.company || '';
            document.getElementById('date-from').value = data.dateFrom || '';
            document.getElementById('date-to').value = data.dateTo || '';
            filterTable();
        }
    </script>
</body>
</html>
